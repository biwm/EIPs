(window.webpackJsonp=window.webpackJsonp||[]).push([[336],{740:function(e,t,a){"use strict";a.r(t);var i=a(46),s=Object(i.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h2",{attrs:{id:"simple-summary"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#simple-summary"}},[e._v("#")]),e._v(" Simple Summary")]),e._v(" "),a("p",[e._v("A transaction pricing mechanism with a fixed-per-block network fee and a median inclusion fee with additive updates.")]),e._v(" "),a("h2",{attrs:{id:"abstract"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#abstract"}},[e._v("#")]),e._v(" Abstract")]),e._v(" "),a("p",[e._v("There is a base fee per gas in protocol, which can move up or down by a maximum of 1/8 in each block. The base fee per gas is adjusted by the protocol to target an average gas usage per block instead of an absolute gas usage per block.  The base fee is increased when blocks are over the gas limit target and decreases when blocks are under the gas limit target. Transaction senders specify their fees by providing "),a("em",[e._v("only one value")]),e._v(":")]),e._v(" "),a("ul",[a("li",[e._v("The fee cap which represents the maximum total (base fee + gas premium) that the transaction sender would be willing to pay to get their transaction included, resembles the current maximum gas price specified by senders but in this protocol change proposal the final gas price paid, most of the time, will be lower than the proposed by the transaction sender.")])]),e._v(" "),a("p",[e._v("Then there is a gas premium that is directly computed as 50% of (fee cap - base fee). This gas premium gets added onto the base fee to calculate the gas price that will be used in the weighted median computation. The gas premium, determined directly by a specified fee cap, can either be set to a fairly low value to compensate miners for uncle rate risk only with the base fee, or to a high value to compete during sudden bursts of activity. Using all transactions that the miner wants to include in the block, a "),a("strong",[e._v("weighted median gas premium")]),e._v(" is computed, not considering in the computation 5% of gas price outliers on the upper-side for extra robustness against miner manipulation.")]),e._v(" "),a("h2",{attrs:{id:"motivation"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#motivation"}},[e._v("#")]),e._v(" Motivation")]),e._v(" "),a("p",[e._v("We target the following goals:")]),e._v(" "),a("ul",[a("li",[e._v("Gas prices spikes are mathematically smoothed out. EIP1559 does not seems to really tackle gas premium volatility and UX.")]),e._v(" "),a("li",[e._v("Maintain gas price preference, i.e. transaction senders willing to pay extra in fees will be rewarded with early preferential inclusion in the blocks, because the miners want to maximize their profits and include transactions with higher fee caps first to maximize the median.")]),e._v(" "),a("li",[e._v("Final gas price paid by the sender is, most of the time, smaller than the maximum gas price specified by sender.")]),e._v(" "),a("li",[e._v("Gas pricing is more robust to sender manipulation or miner manipulation.")])]),e._v(" "),a("p",[e._v('Ethereum currently prices transaction fees using a simple auction mechanism, where users send transactions with bids ("gasprices") and miners choose transactions with the highest bids, and transactions that get included pay the bid that they specify. This leads to several large sources of inefficiency:')]),e._v(" "),a("ul",[a("li",[a("strong",[e._v("Current extreme volatility of gas prices is hurting user experience")]),e._v(": if you observe  online gas price metrics, the current trends in recommended gas prices can change substantially by the minute, making the user experience in the network very awkward. Also, gas volatility makes the mining business more unpredictable and costly, because miners need to spend money hedging the risks.")]),e._v(" "),a("li",[a("strong",[e._v("Mismatch between volatility of transaction fee levels and social cost of transactions")]),e._v(": bids to include transactions on mature public blockchains, that have enough usage so that blocks are full, tend to be extremely volatile. On Ethereum, minimum bids range between 1 nanoeth (10^9 nanoeth = 1 ETH), but sometimes go over 100 nanoeth and have reached over 200 nanoeth. This clearly creates many inefficiencies, because it's absurd to suggest that the cost incurred by the network from accepting one more transaction into a block actually is 200x more when gas prices are 200 nanoeth than when they are 1 nanoeth; in both cases, it's a difference between 8 million gas and 8.02 million gas.")]),e._v(" "),a("li",[a("strong",[e._v("Needless delays for users")]),e._v(': because of the hard per-block gas limit coupled with natural volatility in transaction volume, transactions often wait for several blocks before getting included, but this is socially unproductive; no one significantly gains from the fact that there is no "slack" mechanism that allows one block to be bigger and the next block to be smaller to meet block-by-block differences in demand.')]),e._v(" "),a("li",[a("strong",[e._v("Inefficiencies of first price auctions")]),e._v(": The current approach, where transaction senders publish a transaction with a bid a maximum fee, miners choose the highest-paying transactions, and everyone pays what they bid. This is well-known in mechanism design literature to be highly inefficient, and so complex fee estimation algorithms are required. But even these algorithms often end up not working very well, leading to frequent fee overpayment. We need a more stable fee metric that is computed inside the protocol.")])]),e._v(" "),a("p",[e._v("The proposal in this EIP is to start with a base fee amount which is adjusted up and down by the protocol based on how congested the network is. When the network exceeds the target per-block gas usage, the base fee increases slightly and when capacity is below the target, it decreases slightly. Because these base fee changes are constrained, the maximum difference in base fee from block to block is predictable. This then allows wallets to auto-set the gas fees for users in a highly reliable fashion. It is expected that most users will not have to manually adjust gas fees, even in periods of high network activity. For most users the base fee will be estimated by their wallet and a small gas premium related to the urgency and the priority they want to instill into the transaction.")]),e._v(" "),a("h2",{attrs:{id:"specification"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#specification"}},[e._v("#")]),e._v(" Specification")]),e._v(" "),a("h3",{attrs:{id:"definitions"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#definitions"}},[e._v("#")]),e._v(" Definitions")]),e._v(" "),a("p",[e._v("This is a classic fork without a long migration time.")]),e._v(" "),a("ul",[a("li",[a("code",[e._v("FORK_BLOCK_NUMBER")]),e._v(": TBD.  Block number at or after which EIP-3416 transactions are valid.")]),e._v(" "),a("li",[a("code",[e._v("GAS_TARGET_MAX_CHANGE")]),e._v(": "),a("code",[e._v("1 // 1024")]),e._v(".")]),e._v(" "),a("li",[a("code",[e._v("BLOCK_GAS_USED")]),e._v(": total gas consumed by transaction included in the block.")]),e._v(" "),a("li",[a("code",[e._v("PARENT_GAS_USED")]),e._v(": same as "),a("code",[e._v("BLOCK_GAS_USED")]),e._v(" for parent block.")]),e._v(" "),a("li",[a("code",[e._v("CURRENT_BLOCK")]),e._v(": The current block that is being worked with (either being validated, or being produced).")]),e._v(" "),a("li",[a("code",[e._v("BASE_FEE")]),e._v(": 16th item in the block header. Represents the amount of attoeth burned for every unit of gas a transaction uses.")]),e._v(" "),a("li",[a("code",[e._v("PARENT_BASE_FEE")]),e._v(": same as "),a("code",[e._v("BASE_FEE")]),e._v(" for parent block.")]),e._v(" "),a("li",[a("code",[e._v("BASE_FEE_MAX_CHANGE")]),e._v(": "),a("code",[e._v("1 // 8")])]),e._v(" "),a("li",[a("code",[e._v("INITIAL_BASE_FEE")]),e._v(" : Median gas price in "),a("code",[e._v("FORK_BLOCK_NUMBER - 1")]),e._v(".")])]),e._v(" "),a("h3",{attrs:{id:"process"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#process"}},[e._v("#")]),e._v(" Process")]),e._v(" "),a("ul",[a("li",[e._v("At "),a("code",[e._v("block.number == FORK_BLOCK_NUMBER")]),e._v(" we set "),a("code",[e._v("BASE_FEE = INITIAL_BASE_FEE")])]),e._v(" "),a("li",[a("code",[e._v("BASE_FEE")]),e._v(" is set, from "),a("code",[e._v("FORK_BLOCK_NUMBER + 1")]),e._v(", as follows\n"),a("ul",[a("li",[e._v("Let "),a("code",[e._v("GAS_DELTA = (PARENT_GAS_USED - PARENT_GAS_TARGET) // PARENT_GAS_TARGET")]),e._v(" (possibly negative).")]),e._v(" "),a("li",[e._v("Set "),a("code",[e._v("BASE_FEE = PARENT_BASE_FEE + GSA_DELTA * BASE_FEE_MAX_CHANGE")])])])]),e._v(" "),a("li",[e._v("Transactions since "),a("code",[e._v("FORK_BLOCK_NUMBER")]),e._v(" are encoded the same as the current ones "),a("code",[e._v("rlp([nonce, gasPrice, gasLimit, to, value, data, v, r, s])")]),e._v(" where "),a("code",[e._v("v,r,s")]),e._v(" is a signature of "),a("code",[e._v("rlp([nonce, gasPrice, gasLimit, to, value, data])")]),e._v(" and "),a("code",[e._v("gasPrice")]),e._v(" is the "),a("code",[e._v("FEE_CAP")]),e._v(" specified by the sender according to this proposal.")]),e._v(" "),a("li",[e._v("To produce transactions since "),a("code",[e._v("FORK_BLOCK_NUMBER")]),e._v(", the new "),a("code",[e._v("FEE_CAP")]),e._v(" field (maintaining legacy name of "),a("code",[e._v("gasPrice")]),e._v(" in the transaction) is set as follows (and the "),a("code",[e._v("GAS_PREMIUM")]),e._v(" is computed as specified):\n"),a("ul",[a("li",[a("code",[e._v("FEE_CAP")]),e._v(": "),a("code",[e._v("tx.gasPrice")]),e._v(", serves as the absolute maximum that the transaction sender is willing to pay.")]),e._v(" "),a("li",[a("code",[e._v("GAS_PREMIUM = (FEE_CAP - BASE_FEE) / 2")]),e._v(" serves as a sender-preferred median premium to the miner, beyond the base fee.")]),e._v(" "),a("li",[e._v("If "),a("code",[e._v("FEE_CAP < BASE_FEE")]),e._v(" then the transaction is considered invalid and cannot be included in the current block, but might be included in future blocks.")])])]),e._v(" "),a("li",[e._v("During transaction execution, for EIP3416 transactions we calculate the cost to the "),a("code",[e._v("tx.origin")]),e._v(" and the gain to the "),a("code",[e._v("block.coinbase")]),e._v(" as follows:\n"),a("ul",[a("li",[e._v("Set "),a("code",[e._v("GASPRICE = BASE_FEE + median((tx_i.gasPrice - BASE_FEE) / 2)")]),e._v(" among all transactions "),a("code",[e._v("tx_i")]),e._v(" included in the same block, "),a("em",[e._v("weighted by gas consumed")]),e._v(" and not including the top 5% of outlier gas price in calculation. By weighted median without 5% of the upper-side outliers, we mean that each gas unit spent is ordered according to the corresponding transaction by "),a("code",[e._v("BASE_FEE + tx.gasPrice / 2")]),e._v(" and then the value chosen will be the one separating the lower 95% in two parts.")]),e._v(" "),a("li",[e._v("Let "),a("code",[e._v("GASUSED")]),e._v(" be the gas used during the transaction execution/state transition.")]),e._v(" "),a("li",[e._v("The "),a("code",[e._v("tx.origin")]),e._v(" initially pays "),a("code",[e._v("GASPRICE * tx.gasLimit")]),e._v(", and gets refunded "),a("code",[e._v("GASPRICE * (tx.gasLimit - GASUSED)")]),e._v(".")])])])]),e._v(" "),a("p",[e._v("The miners can still use a "),a("code",[e._v("greedy")]),e._v(" strategy to include new transactions in the proposed blocks by adding the transactions ordered by larger "),a("code",[e._v("FEE_CAP")]),e._v(" first. This is similar to how current blocks are filled, and is a consequence of "),a("code",[e._v("FEE_CAP")]),e._v(" and "),a("code",[e._v("GAS_PREMIUM")]),e._v(" being a positive linear function of each other.")]),e._v(" "),a("h2",{attrs:{id:"rationale"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#rationale"}},[e._v("#")]),e._v(" Rationale")]),e._v(" "),a("p",[e._v("The rationale behind the premium being 50% of (fee cap - base fee) is that at any given point the average network sender has an average fee cap, and we assume that between base fee and fee cap the sender has no specific preference, as long as the transaction is included in some block. Then, the sender is happy with a median premium among this uniform range. Another justification can be that the user also knows that this new version of the pricing protocol for the complete block uses a median, then is fair for him to apply a median within his preferential range, assuming an uniform sampling there. Simulations ("),a("a",{attrs:{href:"https://hackmd.io/c6kyRNMuTnKf_SlolmevRg#An-improvement-for-the-premium",target:"_blank",rel:"noopener noreferrer"}},[e._v("here"),a("OutboundLink")],1),e._v(") with Ethereum gas data shows indeed that median one of the most robust metric.s")]),e._v(" "),a("p",[e._v("The 5% top outliers removal, not considered in the median, or similar number, is to give extra robustness against miner manipulation, because as current network utilization has been around 97% for the last 6 months the miners can include their own transactions on the empty 3% to try to manipulate and increase the median price (even this manipulation effect will be very small on the final price).")]),e._v(" "),a("p",[e._v("The rationale for the "),a("code",[e._v("BASE_FEE")]),e._v(" update formula is that we are using an additive version ("),a("code",[e._v("PARENT_BASE_FEE + GAS_DELTA * BASE_FEE_MAX_CHANGE")]),e._v(") to avoid an attack of senders sending this fee to zero. This attack was simulated and observed for multiplicative formula proposed in previous version ("),a("code",[e._v("PARENT_BASE_FEE + PARENT_BASE_FEE * GAS_DELTA * BASE_FEE_MAX_CHANGE")]),e._v("). See an article about the attack and the simulation "),a("a",{attrs:{href:"https://mtefagh.github.io/fee/",target:"_blank",rel:"noopener noreferrer"}},[e._v("here"),a("OutboundLink")],1),e._v(".")]),e._v(" "),a("p",[e._v("Another rationale for the additive "),a("code",[e._v("BASE_FEE")]),e._v(" update formula is that it guarantees (see "),a("a",{attrs:{href:"https://pdfs.semanticscholar.org/3d2d/773983c5201b58586af463f045befae5bbf2.pdf",target:"_blank",rel:"noopener noreferrer"}},[e._v("this"),a("OutboundLink")],1),e._v(" article) that the optimal execution strategy (scheduling broadcasts in order to pay less fee) for a batch of nonurgent transactions is to spread the transactions across different blocks which in turn helps to avoid network congestion and lowers volatility. For the multiplicative formula, it is exactly the reverse, that is, spikes (dumping all your transactions at once) are incentivized as described "),a("a",{attrs:{href:"https://ethresear.ch/t/path-dependence-of-eip-1559-and-the-simulation-of-the-resulting-permanent-loss/8964",target:"_blank",rel:"noopener noreferrer"}},[e._v("here"),a("OutboundLink")],1),e._v(".")]),e._v(" "),a("p",[e._v("The rationale for the "),a("code",[e._v("BASE_FEE_MAX_CHANGE")]),e._v(" being "),a("code",[e._v("1 // 8")]),e._v(" is that the "),a("code",[e._v("BASE_FEE")]),e._v(" is designed to be very adaptative to block utilization changes.")]),e._v(" "),a("h2",{attrs:{id:"backwards-compatibility"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#backwards-compatibility"}},[e._v("#")]),e._v(" Backwards Compatibility")]),e._v(" "),a("p",[e._v("The backward compatibility is very straightforward because there are no new fields added to the transactions. Pricing of the gas per block on the miner/validator side is still fast to compute but a little more complex. Changes only affect miners/validators. Wallets are no affected by this proposal.")]),e._v(" "),a("h2",{attrs:{id:"test-cases"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#test-cases"}},[e._v("#")]),e._v(" Test Cases")]),e._v(" "),a("p",[e._v("TBD.")]),e._v(" "),a("h2",{attrs:{id:"security-considerations"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#security-considerations"}},[e._v("#")]),e._v(" Security Considerations")]),e._v(" "),a("ul",[a("li",[e._v("Senders cannot manipulate the minimum fee because the minimum "),a("code",[e._v("BASE_FEE")]),e._v(" is controlled by the miners with small increments or decrements on each new block proposed.")]),e._v(" "),a("li",[e._v("Above the "),a("code",[e._v("BASE_FEE")]),e._v(" the senders have a very limited ability to manipulate and lower the final gas price they pay because they have to move the weighted median close to "),a("code",[e._v("BASE_FEE")]),e._v(" and, as we know, this is a very robust statistic.")]),e._v(" "),a("li",[e._v("Miners have a very limited ability to manipulate and raise the final gas price paid by senders above "),a("code",[e._v("BASE_FEE")]),e._v(" because to influence the final gas price they have to stuff fake transactions beyond the top 5% of the blocks. In average and currently, only the top 3% of the block is empty, so to fill-up 5% of the block they need to start dropping profitable transactions to reach 5%. Only beyond 5% of the top block gas they can start moving the median a little and the median is still a very robust statistic, not liable to being easily manipulated.")])]),e._v(" "),a("h2",{attrs:{id:"copyright"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#copyright"}},[e._v("#")]),e._v(" Copyright")]),e._v(" "),a("p",[e._v("Copyright and related rights waived via "),a("a",{attrs:{href:"https://creativecommons.org/publicdomain/zero/1.0/",target:"_blank",rel:"noopener noreferrer"}},[e._v("CC0"),a("OutboundLink")],1),e._v(".")])])}),[],!1,null,null,null);t.default=s.exports}}]);