(window.webpackJsonp=window.webpackJsonp||[]).push([[754],{1179:function(e,t,o){"use strict";o.r(t);var i=o(46),a=Object(i.a)({},(function(){var e=this,t=e.$createElement,o=e._self._c||t;return o("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[o("h2",{attrs:{id:"abstract"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#abstract"}},[e._v("#")]),e._v(" Abstract")]),e._v(" "),o("p",[e._v("We extend "),o("RouterLink",{attrs:{to:"/zh/eip-170.html"}},[e._v("EIP-170")]),e._v(" by introducing a maximum size limit for "),o("code",[e._v("initcode")]),e._v(" ("),o("code",[e._v("MAX_INITCODE_SIZE = 2 * MAX_CODE_SIZE = 49152")]),e._v(").")],1),e._v(" "),o("p",[e._v("Furthermore, we introduce a charge of "),o("code",[e._v("2")]),e._v(" gas for every 32-byte chunk of "),o("code",[e._v("initcode")]),e._v(" to represent the cost of jumpdest-analysis.")]),e._v(" "),o("p",[e._v("Lastly, the size limit results in the nice-to-have property that EVM code size, code offset ("),o("code",[e._v("PC")]),e._v("), and jump offset fits a 16-bit value.")]),e._v(" "),o("h2",{attrs:{id:"motivation"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#motivation"}},[e._v("#")]),e._v(" Motivation")]),e._v(" "),o("p",[e._v("During contract creation the client has to perform jumpdest-analysis on the "),o("code",[e._v("initcode")]),e._v(" prior to execution. The work performed scales linearly with the size of the "),o("code",[e._v("initcode")]),e._v(". This work currently is not metered, nor is there a protocol enforced upper bound for the size.")]),e._v(" "),o("p",[e._v("There are three costs charged today:")]),e._v(" "),o("ol",[o("li",[e._v("Cost for calldata aka "),o("code",[e._v("initcode")]),e._v(": 4 gas for a byte with the value of zero, and 16 gas otherwise.")]),e._v(" "),o("li",[e._v("Cost for the resulting deployed code: 200 gas per byte.")]),e._v(" "),o("li",[e._v("Cost of address calculation (hashing of code) in case of "),o("code",[e._v("CREATE2")]),e._v(" only: 6 gas per word.")])]),e._v(" "),o("p",[e._v("Only the first cost applies to "),o("code",[e._v("initcode")]),e._v(", but only in the case of contract creation transactions. For the case of "),o("code",[e._v("CREATE")]),e._v("/"),o("code",[e._v("CREATE2")]),e._v(" there is no such cost, and it is possible to programmatically generate variations of initcode in a relatively cheap manner. In the past it was possible to craft malicious "),o("code",[e._v("initcode")]),e._v(" due to a vulnerability fixed in 2017 by "),o("a",{attrs:{href:"https://github.com/ethereum/go-ethereum/releases/tag/v1.6.5",target:"_blank",rel:"noopener noreferrer"}},[e._v("geth 1.6.5"),o("OutboundLink")],1),e._v(".")]),e._v(" "),o("p",[e._v("Furthermore the lack of a limit has caused lengthy discussions for some EVM proposals, influencing the design, or even causing a delay or cancellation of a feature.")]),e._v(" "),o("p",[e._v("We are motivated by three reasons:")]),e._v(" "),o("ol",[o("li",[e._v("Ensuring "),o("code",[e._v("initcode")]),e._v(" is fairly charged (most importantly cost is proportional to "),o("code",[e._v("initcode")]),e._v("'s length) to minimize the risks for the future.")]),e._v(" "),o("li",[e._v("To have a cost system which is extendable in the future (i.e. for proposals like EIP-3670).")]),e._v(" "),o("li",[e._v("To simplify EVM engines by the explicit limits (code size, code offsets ("),o("code",[e._v("PC")]),e._v("), and jump offsets fit 16-bits).")])]),e._v(" "),o("h2",{attrs:{id:"specification"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#specification"}},[e._v("#")]),e._v(" Specification")]),e._v(" "),o("h3",{attrs:{id:"parameters"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#parameters"}},[e._v("#")]),e._v(" Parameters")]),e._v(" "),o("table",[o("thead",[o("tr",[o("th",[e._v("Constant")]),e._v(" "),o("th",[e._v("Value")])])]),e._v(" "),o("tbody",[o("tr",[o("td",[o("code",[e._v("INITCODE_WORD_COST")])]),e._v(" "),o("td",[o("code",[e._v("2")])])]),e._v(" "),o("tr",[o("td",[o("code",[e._v("MAX_INITCODE_SIZE")])]),e._v(" "),o("td",[o("code",[e._v("2 * MAX_CODE_SIZE")])])])])]),e._v(" "),o("p",[e._v("Where "),o("code",[e._v("MAX_CODE_SIZE")]),e._v(" is defined by "),o("RouterLink",{attrs:{to:"/zh/eip-170.html"}},[e._v("EIP-170")]),e._v(" as "),o("code",[e._v("24576")]),e._v(".")],1),e._v(" "),o("p",[e._v("We define "),o("code",[e._v("initcode_cost(initcode)")]),e._v(" to equal "),o("code",[e._v("INITCODE_WORD_COST * ceil(len(initcode) / 32)")]),e._v(".")]),e._v(" "),o("h3",{attrs:{id:"rules"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#rules"}},[e._v("#")]),e._v(" Rules")]),e._v(" "),o("ol",[o("li",[e._v("If length of transaction data ("),o("code",[e._v("initcode")]),e._v(") in a create transaction exceeds "),o("code",[e._v("MAX_INITCODE_SIZE")]),e._v(", execution results in an exceptional abort. Such a transaction is valid and may be included in a block.")]),e._v(" "),o("li",[e._v("For a create transaction, extend the transaction data cost formula to include "),o("code",[e._v("initcode_cost(initcode)")]),e._v(".")]),e._v(" "),o("li",[e._v("If length of "),o("code",[e._v("initcode")]),e._v(" to "),o("code",[e._v("CREATE")]),e._v(" or "),o("code",[e._v("CREATE2")]),e._v(" instructions exceeds "),o("code",[e._v("MAX_INITCODE_SIZE")]),e._v(", execution results in an exceptional abort.")]),e._v(" "),o("li",[e._v("For the "),o("code",[e._v("CREATE")]),e._v(" and "),o("code",[e._v("CREATE2")]),e._v(" instructions charge an extra gas cost equaling to "),o("code",[e._v("initcode_cost(initcode)")]),e._v(". This cost is deducted before the calculation of the resulting contract address and the execution of "),o("code",[e._v("initcode")]),e._v(". (Note that this means before or at the same time as the hashing cost is applied in "),o("code",[e._v("CREATE2")]),e._v(".)")])]),e._v(" "),o("h2",{attrs:{id:"rationale"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#rationale"}},[e._v("#")]),e._v(" Rationale")]),e._v(" "),o("h3",{attrs:{id:"gas-cost-constant"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#gas-cost-constant"}},[e._v("#")]),e._v(" Gas cost constant")]),e._v(" "),o("p",[e._v("The value of "),o("code",[e._v("INITCODE_WORD_COST")]),e._v(" is selected based on performance benchmarks of differing worst-cases per implementation. The baseline for the benchmarks is the performance of "),o("code",[e._v("KECCAK256")]),e._v(" hashing in geth 1.10.9, which matches the 70 Mgas/s gas limit target on a 4.0 GHz x86_64 CPU.")]),e._v(" "),o("table",[o("thead",[o("tr",[o("th",[e._v("EVM")]),e._v(" "),o("th",[e._v("version")]),e._v(" "),o("th",[e._v("MB/s")]),e._v(" "),o("th",[e._v("B/CPUcycle")]),e._v(" "),o("th",[e._v("CPUcycle/B")]),e._v(" "),o("th",[e._v("cost of 1 B")]),e._v(" "),o("th",[e._v("cost of 32 B")])])]),e._v(" "),o("tbody",[o("tr",[o("td",[e._v("geth/KECCAK256")]),e._v(" "),o("td",[e._v("1.10.9")]),e._v(" "),o("td",[e._v("357")]),e._v(" "),o("td",[e._v("1.8")]),e._v(" "),o("td",[e._v("0.6")]),e._v(" "),o("td",[e._v("0.2")]),e._v(" "),o("td",[e._v("6.0")])]),e._v(" "),o("tr",[o("td",[e._v("geth")]),e._v(" "),o("td",[e._v("1.10.9")]),e._v(" "),o("td",[e._v("1091")]),e._v(" "),o("td",[e._v("5.5")]),e._v(" "),o("td",[e._v("0.2")]),e._v(" "),o("td",[e._v("0.1")]),e._v(" "),o("td",[e._v("2.0")])]),e._v(" "),o("tr",[o("td",[e._v("evmone/Baseline")]),e._v(" "),o("td",[e._v("0.8.2")]),e._v(" "),o("td",[e._v("727")]),e._v(" "),o("td",[e._v("3.7")]),e._v(" "),o("td",[e._v("0.3")]),e._v(" "),o("td",[e._v("0.1")]),e._v(" "),o("td",[e._v("2.9")])]),e._v(" "),o("tr",[o("td",[e._v("evmone/Advanced")]),e._v(" "),o("td",[e._v("0.8.2")]),e._v(" "),o("td",[e._v("155")]),e._v(" "),o("td",[e._v("0.8")]),e._v(" "),o("td",[e._v("1.3")]),e._v(" "),o("td",[e._v("0.4")]),e._v(" "),o("td",[e._v("13.8")])])])]),e._v(" "),o("h3",{attrs:{id:"gas-cost-per-word-32-byte-chunk"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#gas-cost-per-word-32-byte-chunk"}},[e._v("#")]),e._v(" Gas cost per word (32-byte chunk)")]),e._v(" "),o("p",[e._v("We have chosen the cost of 2 gas per word based on Geth's implementation and comparing with "),o("code",[e._v("KECCAK256")]),e._v(" performance. This means the per byte cost is "),o("code",[e._v("0.0625")]),e._v(". While fractional gas costs are not permitted in the EVM, we can approximate it by charging per-word.")]),e._v(" "),o("p",[e._v("Moreover, calculating gas per word is compatible with the calculation of "),o("code",[e._v("CREATE2")]),e._v("'s "),o("em",[e._v("hashcost")]),e._v(" of "),o("RouterLink",{attrs:{to:"/zh/eip-1014.html"}},[e._v("EIP-1014")]),e._v(". Therefore the same implementation may be used for "),o("code",[e._v("CREATE")]),e._v(" and "),o("code",[e._v("CREATE2")]),e._v(" with different cost constants: before activation "),o("code",[e._v("0")]),e._v(" for "),o("code",[e._v("CREATE")]),e._v(" and "),o("code",[e._v("6")]),e._v(" for "),o("code",[e._v("CREATE2")]),e._v(", after activation "),o("code",[e._v("2")]),e._v(" for "),o("code",[e._v("CREATE")]),e._v(" and "),o("code",[e._v("6 + 2")]),e._v(" for "),o("code",[e._v("CREATE2")]),e._v(".")],1),e._v(" "),o("h3",{attrs:{id:"reason-for-size-limit-of-initcode"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#reason-for-size-limit-of-initcode"}},[e._v("#")]),e._v(" Reason for size limit of initcode")]),e._v(" "),o("p",[e._v("Estimating and creating worst case scenarios is easier with an upper bound in place, given one parameter for the search is greatly reduced. This allows for selecting a much more optimistic gas per byte.")]),e._v(" "),o("p",[e._v("Should there be no upper bound, the cost would need to be higher accounting for unknown unknowns. Given most "),o("em",[e._v("initcode")]),e._v(" ("),o("em",[e._v("TODO: state maximum initcode size resulting in deployment seen on mainnet here")]),e._v(") does not exceed the proposed limit, penalising contracts by overly conservative costs seems unnecessary.")]),e._v(" "),o("h3",{attrs:{id:"effect-of-size-limit-of-initcode"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#effect-of-size-limit-of-initcode"}},[e._v("#")]),e._v(" Effect of size limit of initcode")]),e._v(" "),o("p",[e._v("In most, if not all cases when a new contract is being created, the resulting runtime code is copied from the initcode itself. For the basic case the "),o("code",[e._v("2 * MAX_CODE_SIZE")]),e._v(" limit allows "),o("code",[e._v("MAX_CODE_SIZE")]),e._v(" for runtime code and another "),o("code",[e._v("MAX_CODE_SIZE")]),e._v(" for contract constructor code. However, the limit may have practical implications for cases where multiple contracts are deployed in a single create transaction.")]),e._v(" "),o("h3",{attrs:{id:"initcode-cost-for-create-transaction"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#initcode-cost-for-create-transaction"}},[e._v("#")]),e._v(" Initcode cost for create transaction")]),e._v(" "),o("p",[e._v("The initcode cost for create transaction data (0.0625 gas per byte) is negligible compared to the transaction data cost (4 or 16 gas per byte). Despite that, we decided to include it in the specification for consistency, and more importantly for forward compatibility.")]),e._v(" "),o("h3",{attrs:{id:"how-to-report-initcode-limit-violation"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#how-to-report-initcode-limit-violation"}},[e._v("#")]),e._v(" How to report initcode limit violation?")]),e._v(" "),o("p",[e._v("We specified that initcode size limit and word cost results in an exceptional abort. Most checks in "),o("code",[e._v("CREATE")]),e._v("/"),o("code",[e._v("CREATE2")]),e._v(' are specified this way, with the exception of two (call depth limit, and insufficient endowment). In these two cases the instructions return the zero address. However we do not think this "method" of error report is precise enough, and thus useful.')]),e._v(" "),o("p",[e._v("Returning zero instead of exceptional abort in the new cases would also mean that the order of checks must be specified to avoid potential consensus issues between clients.")]),e._v(" "),o("h2",{attrs:{id:"backwards-compatibility"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#backwards-compatibility"}},[e._v("#")]),e._v(" Backwards Compatibility")]),e._v(" "),o("p",[e._v('This EIP requires a "network upgrade", since it modifies consensus rules.')]),e._v(" "),o("p",[e._v("Already deployed contracts should not be effected, but certain transactions (with "),o("code",[e._v("initcode")]),e._v(" beyond the proposed limit) would still be includable in a block, but result in an exceptional abort.")]),e._v(" "),o("h2",{attrs:{id:"security-considerations"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#security-considerations"}},[e._v("#")]),e._v(" Security Considerations")]),e._v(" "),o("p",[e._v("For client implementations, this EIP makes attacks based on jumpdest-analysis less problematic, so should increase the robustness of clients.")]),e._v(" "),o("p",[e._v("For layer 2, this EIP introduces failure-modes where there previously were none. There "),o("em",[e._v("could")]),e._v(" exist factory-contracts which deploy multi-level contract hierarchies, such that the code for multiple contracts are included in the initcode of the first contract. The author(s) of this EIP are not aware of any such contracts.")]),e._v(" "),o("p",[e._v("Currently, on London, with "),o("code",[e._v("30M")]),e._v(" gas limit, it would be possible to trigger jumpdest-analysis of a total "),o("code",[e._v("~1.3GB")]),e._v(" of initcode. With this EIP, the cost for such an attack would increase by roughly "),o("code",[e._v("80M")]),e._v(" gas.")]),e._v(" "),o("h2",{attrs:{id:"test-cases"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#test-cases"}},[e._v("#")]),e._v(" Test Cases")]),e._v(" "),o("p",[e._v("Tests should include the following cases:")]),e._v(" "),o("ul",[o("li",[o("code",[e._v("CREATE")]),e._v("/"),o("code",[e._v("CREATE2")]),e._v("/"),o("code",[e._v("tx create")]),e._v(" with "),o("code",[e._v("len(initcode)")]),e._v(" at "),o("code",[e._v("MAX_INITCODE_SIZE")])]),e._v(" "),o("li",[o("code",[e._v("CREATE")]),e._v("/"),o("code",[e._v("CREATE2")]),e._v("/"),o("code",[e._v("tx create")]),e._v(" with "),o("code",[e._v("len(initcode)")]),e._v(" at "),o("code",[e._v("MAX_INITCODE_SIZE+1")])])]),e._v(" "),o("h2",{attrs:{id:"copyright"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#copyright"}},[e._v("#")]),e._v(" Copyright")]),e._v(" "),o("p",[e._v("Copyright and related rights waived via "),o("a",{attrs:{href:"https://creativecommons.org/publicdomain/zero/1.0/",target:"_blank",rel:"noopener noreferrer"}},[e._v("CC0"),o("OutboundLink")],1),e._v(".")])])}),[],!1,null,null,null);t.default=a.exports}}]);